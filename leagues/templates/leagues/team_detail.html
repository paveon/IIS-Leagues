{% extends 'leagues/base.html' %}
{% block title %}Teams | {{ team.name }} {% endblock %}

{% block scripts %}
  <script>
      function openDialog(text, type, confirmCallback) {
          $('#confirm_bar').show()
          $('#dialog_text').text(text);
          if (confirmCallback) {
              $('#dialog_confirm').attr('onclick',
                  confirmCallback.name + '(\'' + arguments[2] + '\', \'' + arguments[3] + '\')');
          }
          $('#dialog').show();
      }


      function buttonClick(id, action) {
          $.ajax({
              type: 'POST',
              url: "{% url 'leagues:social' %}",
              data: {
                  'csrfmiddlewaretoken': '{{ csrf_token }}',
                  'action': action,
                  'object_id': id,
                  'player_id': {{ user.player.id }}
              },
              dataType: "json",
              async: true,
              success: function (json) {
                  if (json['error'] == "players") {
                      openDialog('Not enough players in team to join tournament');
                      $('#confirm_bar').hide();
                  }
                  else if (json['error'] == "teams") {
                      openDialog('Another team from your clan is already registered for this tournament');
                      $('#confirm_bar').hide();
                  }
                  else {
                      location.reload();
                  }
              },
              error: function (xhr, error) {
                  console.log("AJAX failure");
                  console.log(xhr);
                  console.log(error);
              }
          });
      }
  </script>
{% endblock %}

{% block left_panel %}
  {% with side_bars_enabled=True %}
    {{ block.super }}
  {% endwith %}
{% endblock left_panel %}


{% block content %}
  <div class="w3-container w3-margin-bottom flex-container" style="flex: 2 1 0;">
    <div class="w3-card w3-round-large w3-white" style="max-width: 1000px; flex: 1 1 auto;">
      <header>
        <h1 style="text-align: center; font-family: 'Audiowide', cursive;">{{ team.name }}</h1>

        <ul class="section-bar" style="flex: 1 1 auto">
          <li onclick="showSection(event, 'info');" id="info_tab"
              class="section-tab w3-bottombar w3-hover-light-grey w3-padding">
            Team info
          </li>
          <li onclick="showSection(event, 'members');" id="members_tab"
              class="section-tab w3-bottombar w3-hover-light-grey w3-padding">
            Members
          </li>
          <li  onclick="showSection(event, 'tournaments');" id="tournaments_tab"
            class="section-tab w3-bottombar w3-hover-light-grey w3-padding">
          Tournaments
          </li>
          <li onclick="showSection(event, 'matches');" id="matches_tab"
              class="section-tab w3-bottombar w3-hover-light-grey w3-padding">
            Matches
          </li>
          <li onclick="showSection(event, 'stats');" id="stats_tab"
              class="section-tab w3-bottombar w3-hover-light-grey w3-padding">
            Statistics
          </li>
        </ul>
      </header>

      <div id="info" class="w3-container w3-section section">
        <h4><b>Active:</b>
          {% if team.active %}
            <i class="fas fa-check-circle"></i>
          {% else %}
            <i class="fas fa-times-circle"></i>
          {% endif %}
        </h4>

        <h4><b>Leader:</b>
          {% if team.leader %}
            <a href="{% url 'leagues:player_detail' team.leader.slug %}">{{ team.leader }}</a>
          {% else %}
            None
          {% endif %}
        </h4>

        <h4><b>Founded:</b> {{ team.founded|default:""|date:"j.n.Y" }}</h4>

        <h4><b>Game of interest:</b>
          {% if team.game %}
            <a href="{% url 'leagues:game_detail' team.game.slug %}">{{ team.game }}</a>
          {% else %}
            None
          {% endif %}
        </h4>
        <h4><b>Clan:</b>
          {% if team.clan %}
            <a href="{% url 'leagues:clan_detail' team.clan.slug %}">{{ team.clan }}</a>
          {% else %}
            None
          {% endif %}
        </h4>
        <h4><b>Description:</b></h4>
        <article class="w3-container">
          <p style="margin:0;">{{ team.description }}</p>
        </article>
      </div>

      <div id="members" class="w3-container w3-section section">
        <h3>Members</h3>
        <div class="pagedTable w3-card w3-round">
          <table class="w3-table w3-striped w3-bordered w3-hoverable">
            <thead>
            <tr class="">
              <th>Nickname</th>
              <th>Games won</th>
              <th>Games total</th>
              <th>Win ratio</th>
            </tr>
            </thead>

            <tbody id="member_rows">
            {% for member in member_matches %}
              <tr style="display: none">
                <td>
                  <a href="{% url 'leagues:player_detail' member.0.slug %}">
                    {{ member.0.nickname }}
                  </a>
                </td>
                <td>{{ member.2.count }}</td>
                <td>{{ member.1.count }}</td>
                <td>{{ member.0.win_ratio|default:"No games" }}</td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
          {% include 'leagues/table_footer.html' %}
        </div>
      </div>

      <div id="tournaments" class="w3-container w3-section section">
      {% if user.player == user.player.clan.leader %}
        <div class="w3-section flex-container">
          <div class="w3-margin-right" style="flex: 1 1 0">
      {% endif %}
            <h3>Registered tournaments</h3>
            <div class="pagedTable w3-card w3-round">
              <table class="w3-table w3-striped w3-bordered w3-hoverable">
                <thead>
                <tr class="">
                  <th>Name</th>
                  <th>Status</th>
                  {% if user.player == user.player.clan.leader %}
                    <th></th>
                  {% endif %}
                </tr>
                </thead>

                <tbody id="matches_rows">
                {% for tournament in registered %}
                  <tr style="display: none;">
                    <td><a href="{% url 'leagues:tournament_detail' tournament.slug %}">{{ tournament.name }}</a></td>
                    <td>
                      {% if tournament.in_progress %}
                        In progress
                      {% elif tournament.upcoming %}
                        Upcoming
                      {% else %}
                        Finished
                      {% endif %}
                    </td>
                  {% if user.player == user.player.clan.leader %}
                    {% if tournament.opening_date > now %}
                      <td class="w3-padding-3 w3-small table_button_center">
                        <button onclick="openDialog('Do you really wish to leave \'{{ tournament.name }}\'?',
                            buttonClick, {{ tournament.id }}, 'leave_tournament')"
                                class="w3-button w3-red table_button leave_button">
                          Leave
                        </button>
                      </td>
                    {% else %}
                      <td></td>
                    {% endif %}
                  {% endif %}
                  </tr>
                {% endfor %}
                </tbody>
              </table>
              {% include 'leagues/table_footer.html' %}
            </div>
      {% if user.player == user.player.clan.leader %}
          </div>
          <div style="flex: 1 1 0">
            <h3>Tournaments to register</h3>
            <div class="pagedTable w3-card w3-round">
              <table class="w3-table w3-striped w3-bordered w3-hoverable">
                <thead>
                <tr class="">
                  <th>Name</th>
                  <th></th>
                </tr>
                </thead>

                <tbody id="matches_rows">
                {% for tournament in non_registered %}
                  <tr style="display: none;">
                    <td><a href="{% url 'leagues:team_detail' tournament.slug %}">{{ tournament.name }}</a></td>
                    <td class="w3-padding-3 w3-small table_button_center">
                      {% if tournament and tournament.opening_date > now %}
                        <button onclick="buttonClick({{ tournament.id }}, 'join_tournament')"
                                class="w3-button w3-green table_button join_button">
                          Join
                        </button>
                      {% else %}
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
                </tbody>
              </table>
              {% include 'leagues/table_footer.html' %}
            </div>
          </div>
        </div>
      {% endif %}
      </div>

      <div id="matches" class="w3-container w3-section section">
        <h3>Matches</h3>
        <div class="pagedTable w3-card w3-round">
          <table class="w3-table w3-striped w3-bordered w3-hoverable">
            <thead>
            <tr class="">
              <th>Versus</th>
              <th>Start</th>
              <th>Duration</th>
              <th>Winner</th>
              <th>Tournament</th>
              <th>Game</th>
              <th></th>
            </tr>
            </thead>

            <tbody id="matches_rows">
            {% for match in team.all_matches %}
              <tr style="display: none;">
                <td><a href="{% url 'leagues:team_detail' match.team_1.slug %}">{{ match.team_1.name }}</a>
                  VS <a href="{% url 'leagues:team_detail' match.team_2.slug %}">{{ match.team_2.name }}</a></td>
                <td>{{ match.beginning }}</td>
                <td>
                  {% if match.duration %}
                    {{ match.duration }}
                  {% else %}
                    Not ended yet
                  {% endif %}
                </td>
                <td>
                  {% if match.duration %}
                    {{ match.winner }}
                  {% endif %}
                </td>
                <td>
                  {% if match.tournament %}
                    <a href="{% url 'leagues:tournament_detail' match.tournament.slug %}">{{ match.tournament.name }}</a>
                  {% endif %}
                </td>
                <td>{{ match.game }}</td>
                <td><a href="{% url 'leagues:match_detail' match.id %}"><i class="fa fa-eye"></i></a></td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
          {% include 'leagues/table_footer.html' %}
        </div>
      </div>


      <div id="stats" class="w3-container w3-section section">
        <h4>Win ratio: {{ team.win_ratio|default:"No matches" }}</h4>
        <h4>Member count: {{ team.team_members.count }}</h4>
        <h4>Matches played: {{ team.all_matches.count }}</h4>
        <h4>Matches won: {{ team.matches_won.count }}</h4>
      </div>

    </div>
  </div>
{% endblock %}


{% block right_panel %}
  {% with side_bars_enabled=True %}
    {{ block.super }}
  {% endwith %}
{% endblock right_panel %}

{% block endpage %}
  {% load widget_tweaks %}
  <div id="dialog" class="w3-modal" style="display: none">
    <div class="w3-modal-content w3-card-4" style="max-width:600px">

      <header class="w3-container w3-center w3-light-grey w3-border-bottom">
        <h3 id="dialog_text">Placeholder Text</h3>

        <button onclick="$('#dialog').hide()" type="button"
                class="w3-button w3-display-topright w3-red">
          <i class="fa fa-times"></i>
        </button>
      </header>

      <div class="w3-container w3-border-top w3-padding-16 w3-light-grey" id="confirm_bar">
        <button onclick="$('#dialog').hide()" type="button" id="dialog_decline"
                class="w3-button w3-red">No
        </button>

        <button onclick="$('#dialog').hide()" type="button" id="dialog_confirm"
                class="w3-button w3-green w3-right">Yes
        </button>
      </div>
    </div>
  </div>
{% endblock %}